# ============================================================================
# A-Quartet GitHub Actions CI/CD Pipeline
# ============================================================================
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” push ë˜ëŠ” PR ì‹œ ìë™ìœ¼ë¡œ ë¹Œë“œí•˜ê³ ,
# íƒœê·¸(v*) push ì‹œ GitHub Releaseì— ë¹Œë“œ ê²°ê³¼ë¬¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
# ============================================================================

name: ğŸ›¡ï¸ A-Quartet Build & Release

on:
  push:
    branches: [ master, main, develop ]
    tags: [ 'v*' ]           # v1.0.0 ê°™ì€ íƒœê·¸ push ì‹œ Release ìƒì„±
  pull_request:
    branches: [ master, main ]

  workflow_dispatch:          # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_PATH: src/AQuartet.App
  SOLUTION_PATH: AQuartet.slnx

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Build & Test
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ”¨ Build (${{ matrix.configuration }})
    runs-on: windows-latest   # WPFëŠ” Windowsì—ì„œë§Œ ë¹Œë“œ ê°€ëŠ¥

    strategy:
      matrix:
        configuration: [ Release ]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Restore NuGet Packages
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: ğŸ”¨ Build
        run: >
          dotnet build ${{ env.SOLUTION_PATH }}
          --configuration ${{ matrix.configuration }}
          --no-restore

      # â”€â”€ Single-file Publish â”€â”€
      - name: ğŸ“¤ Publish (Single-file)
        if: github.event_name == 'push'
        run: >
          dotnet publish ${{ env.PROJECT_PATH }}
          --configuration ${{ matrix.configuration }}
          --runtime win-x64
          --self-contained false
          --output ./publish/framework-dependent
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true

      # â”€â”€ Self-contained Publish (Runtime í¬í•¨, ì„¤ì¹˜ ì—†ì´ ì‹¤í–‰ ê°€ëŠ¥) â”€â”€
      - name: ğŸ“¤ Publish (Self-contained)
        if: startsWith(github.ref, 'refs/tags/v')
        run: >
          dotnet publish ${{ env.PROJECT_PATH }}
          --configuration ${{ matrix.configuration }}
          --runtime win-x64
          --self-contained true
          --output ./publish/self-contained
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:EnableCompressionInSingleFile=true

      # â”€â”€ ë¹Œë“œ ê²°ê³¼ë¬¼ ì•„ì¹´ì´ë¸Œ â”€â”€
      - name: ğŸ—œï¸ Zip Artifacts (Framework-dependent)
        if: github.event_name == 'push'
        run: Compress-Archive -Path ./publish/framework-dependent/* -DestinationPath ./AQuartet-win-x64.zip

      - name: ğŸ—œï¸ Zip Artifacts (Self-contained)
        if: startsWith(github.ref, 'refs/tags/v')
        run: Compress-Archive -Path ./publish/self-contained/* -DestinationPath ./AQuartet-win-x64-standalone.zip

      # â”€â”€ Artifact ì—…ë¡œë“œ (PRì´ë‚˜ ì¼ë°˜ pushì—ì„œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥) â”€â”€
      - name: â¬†ï¸ Upload Build Artifact
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: AQuartet-win-x64
          path: ./AQuartet-win-x64.zip
          retention-days: 30

      # â”€â”€ GitHub Release ìƒì„± (íƒœê·¸ push ì‹œì—ë§Œ) â”€â”€
      - name: ğŸš€ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          files: |
            ./AQuartet-win-x64.zip
            ./AQuartet-win-x64-standalone.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
